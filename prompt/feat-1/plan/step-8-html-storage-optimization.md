# HTML ì €ì¥ ë°©ì‹ ìµœì í™” ë° í…œí”Œë¦¿ ì‹œìŠ¤í…œ ì¤€ë¹„

> [!NOTE]
> **í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸**:
> í˜„ì¬ëŠ” ê°„ë‹¨í•œ í¼ ì…ë ¥ìœ¼ë¡œ HTMLì„ ìƒì„±í•˜ì§€ë§Œ, **í–¥í›„ í…œí”Œë¦¿ ì‹œìŠ¤í…œ**(ì´ë²¤íŠ¸, í• ì¸, ê³µì§€ì‚¬í•­ ë“± ë‹¤ì–‘í•œ í…œí”Œë¦¿)ì„ ë„ì…í•  ê³„íšì…ë‹ˆë‹¤.
> í…œí”Œë¦¿ ì‹œìŠ¤í…œ ë„ì… ì‹œ HTMLì„ Storageì— ì €ì¥í•˜ëŠ” ë°©ì‹ì´ ìœ ë¦¬í•©ë‹ˆë‹¤.

## [ëª©í‘œ]

1. **í˜„ì¬**: ë°ì´í„°ë² ì´ìŠ¤(`flyers.html_content`)ì— HTML ì €ì¥
2. **í–¥í›„**: Supabase Storageì— HTML íŒŒì¼ ì €ì¥, DBì—ëŠ” URLë§Œ ì €ì¥
3. **ëª©ì **: í…œí”Œë¦¿ ì‹œìŠ¤í…œ ë„ì…ì„ ìœ„í•œ ë°ì´í„° êµ¬ì¡° ìµœì í™”

---

## í…œí”Œë¦¿ ì‹œìŠ¤í…œì—ì„œ Storage ì €ì¥ì´ ìœ ë¦¬í•œ ì´ìœ 

### 1. **ë°ì´í„° ë¶„ë¦¬ ì›ì¹™**

**í˜„ì¬ ë°©ì‹ (DBì— html_content)**:
```
flyers í…Œì´ë¸”:
â”œâ”€â”€ title
â”œâ”€â”€ description
â”œâ”€â”€ html_content  â† êµ¬ì¡°í™”ëœ ë°ì´í„°ì™€ ë Œë”ë§ ê²°ê³¼ê°€ ì„ì„
â””â”€â”€ image_url
```

**Storage ë°©ì‹ (í…œí”Œë¦¿ ì‹œìŠ¤í…œ)**:
```
flyers í…Œì´ë¸” (êµ¬ì¡°í™”ëœ ë°ì´í„°):
â”œâ”€â”€ title
â”œâ”€â”€ description
â”œâ”€â”€ template_id     â† 'event', 'sale', 'notice'
â”œâ”€â”€ form_data       â† ì›ë³¸ í¼ ë°ì´í„° (JSONB)
â”œâ”€â”€ html_url        â† Storage ë§í¬
â””â”€â”€ image_url

Storage (ë Œë”ë§ ê²°ê³¼):
â””â”€â”€ flyers/html/<uuid>.html  â† ìƒì„±ëœ HTML íŒŒì¼
```

**ì¥ì **:
- âœ… ì—­í•  ë¶„ë¦¬: DBëŠ” ë°ì´í„°, StorageëŠ” ê²°ê³¼ë¬¼
- âœ… ìœ ì—°ì„±: í…œí”Œë¦¿ ë³€ê²½ ì‹œ form_dataë¡œ ì¬ìƒì„± ê°€ëŠ¥
- âœ… í™•ì¥ì„±: ì—¬ëŸ¬ í…œí”Œë¦¿ ê´€ë¦¬ ìš©ì´

### 2. **í…œí”Œë¦¿ ë²„ì „ ê´€ë¦¬**

**ì‹œë‚˜ë¦¬ì˜¤**: í…œí”Œë¦¿ì„ ì—…ë°ì´íŠ¸í–ˆì„ ë•Œ

```typescript
// í…œí”Œë¦¿ ì˜ˆì‹œ
const templates = {
  'basic': BasicTemplate,
  'event': EventTemplate,     // v1.0
  'sale': SaleTemplate,
};

// ë‚˜ì¤‘ì— EventTemplate v2.0ìœ¼ë¡œ ì—…ë°ì´íŠ¸
```

**DB ì €ì¥ ì‹œ ë¬¸ì œ**:
- âŒ ê¸°ì¡´ ì „ë‹¨ì§€ì˜ `html_content`ê°€ v1.0 í…œí”Œë¦¿ìœ¼ë¡œ ìƒì„±ë¨
- âŒ í…œí”Œë¦¿ ë³€ê²½ ì‹œ ê¸°ì¡´ HTMLì´ ì˜ë¯¸ ì—†ì–´ì§
- âŒ ì¬ìƒì„±í•˜ì§€ ì•Šìœ¼ë©´ ì¼ê´€ì„± ê¹¨ì§

**Storage ì €ì¥ ì‹œ í•´ê²°**:
- âœ… ìƒì„± ì‹œì ì˜ HTML ìŠ¤ëƒ…ìƒ· ë³´ì¡´ (Storage íŒŒì¼)
- âœ… ì›ë³¸ ë°ì´í„°(`form_data`) ë³´ì¡´ìœ¼ë¡œ ì¬ìƒì„± ê°€ëŠ¥
- âœ… ì‚¬ìš©ì ì„ íƒìœ¼ë¡œ ì¬ìƒì„± ë˜ëŠ” ìœ ì§€ ê°€ëŠ¥

```typescript
// ì¬ìƒì„± ì˜ˆì‹œ
async function regenerateFlyer(flyerUuid: string) {
  const { data: flyer } = await supabase
    .from('flyers')
    .select('template_id, form_data')
    .eq('uuid', flyerUuid)
    .single();

  // ìµœì‹  í…œí”Œë¦¿ìœ¼ë¡œ ì¬ìƒì„±
  const template = templates[flyer.template_id];
  const newHTML = template.render(flyer.form_data);

  // Storageì— ë®ì–´ì“°ê¸°
  await uploadHTMLToStorage({ flyerUuid, htmlContent: newHTML });
}
```

### 3. **ë³µì¡í•œ í…œí”Œë¦¿ HTML**

**ê°„ë‹¨í•œ í…œí”Œë¦¿** (í˜„ì¬):
```html
<div>
  <h1>{title}</h1>
  <img src="{image}" />
  <p>{description}</p>
</div>
```
â†’ HTML í¬ê¸°: **1~5KB**

**ë³µì¡í•œ í…œí”Œë¦¿** (í–¥í›„):
```html
<!-- ì´ë²¤íŠ¸ í…œí”Œë¦¿ -->
<div class="event-template">
  <header class="hero">
    <div class="countdown-timer">...</div>
    <h1 class="title-with-effects">{title}</h1>
    <div class="badge-group">...</div>
  </header>
  <section class="image-gallery">
    <!-- 10+ images with lightbox -->
  </section>
  <section class="event-details">
    <!-- ë³µì¡í•œ ë ˆì´ì•„ì›ƒ -->
  </section>
  <section class="registration-form">...</section>
  <footer>...</footer>
  <style>
    /* ì¸ë¼ì¸ CSS: 5KB+ */
    .event-template { /* ë³µì¡í•œ ìŠ¤íƒ€ì¼ */ }
  </style>
</div>
```
â†’ HTML í¬ê¸°: **50KB ~ 100KB+**

**ê²°ë¡ **: í…œí”Œë¦¿ì´ ë³µì¡í•´ì§ˆìˆ˜ë¡ Storage ì €ì¥ì´ ìœ ë¦¬

### 4. **í…œí”Œë¦¿ë³„ ì»¤ìŠ¤í…€ í•„ë“œ**

**form_data JSONB ì˜ˆì‹œ**:

```json
// Basic í…œí”Œë¦¿
{
  "title": "ê³µì§€ì‚¬í•­",
  "description": "ì¼ë°˜ ë‚´ìš©",
  "imageUrls": ["url1", "url2"]
}

// Event í…œí”Œë¦¿
{
  "title": "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì´ë²¤íŠ¸",
  "description": "ì—°ë§ íŠ¹ê°€",
  "imageUrls": ["url1", "url2", "url3"],
  "eventDate": "2025-12-25",
  "location": "ì„œìš¸",
  "registrationLink": "https://...",
  "tags": ["ì´ë²¤íŠ¸", "í• ì¸"]
}

// Sale í…œí”Œë¦¿
{
  "title": "50% ëŒ€í• ì¸",
  "description": "ì—°ë§ ì •ë¦¬ ì„¸ì¼",
  "imageUrls": ["product1", "product2"],
  "discountRate": 50,
  "originalPrice": 100000,
  "salePrice": 50000,
  "validUntil": "2025-12-31"
}
```

â†’ DBì— `form_data` JSONBë¡œ ì €ì¥í•˜ë©´ í…œí”Œë¦¿ë³„ ìœ ì—°í•œ ë°ì´í„° ê´€ë¦¬ ê°€ëŠ¥

---

## ê¶Œì¥ DB ìŠ¤í‚¤ë§ˆ (í…œí”Œë¦¿ ì‹œìŠ¤í…œ ëŒ€ë¹„)

### [ìˆ˜ì •] `schema.sql`

```sql
-- Flyers í…Œì´ë¸” ìˆ˜ì •
create table public.flyers (
  id bigint generated by default as identity primary key,
  uuid uuid default uuid_generate_v4() not null unique,

  -- ê¸°ë³¸ ì •ë³´
  title text not null,
  description text,

  -- í…œí”Œë¦¿ ì‹œìŠ¤í…œ (7ë‹¨ê³„ì—ì„œ í™œì„±í™”)
  template_id text not null default 'basic',  -- 'basic', 'event', 'sale', 'notice' ë“±
  form_data jsonb not null,  -- ì›ë³¸ í¼ ë°ì´í„° (ì¬ìƒì„± ê°€ëŠ¥)

  -- ë Œë”ë§ ê²°ê³¼
  html_url text,  -- Storageì— ì €ì¥ëœ HTML íŒŒì¼ URL (8ë‹¨ê³„ì—ì„œ í™œì„±í™”)
  html_content text,  -- ë°±ì—…ìš© (5ë‹¨ê³„ì—ì„œ ì‚¬ìš©, 8ë‹¨ê³„ ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì‚­ì œ ê°€ëŠ¥)
  image_url text,  -- ì¸ë„¤ì¼

  -- ë©”íƒ€ ì •ë³´
  user_id uuid references public.users(uuid) on delete cascade not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- í…œí”Œë¦¿ ì¸ë±ìŠ¤
create index flyers_template_id_idx on public.flyers(template_id);

-- form_data ì¸ë±ìŠ¤ (íŠ¹ì • í•„ë“œ ê²€ìƒ‰ ì‹œ)
create index flyers_form_data_idx on public.flyers using gin(form_data);
```

**í•„ë“œ ì„¤ëª…**:
- `template_id`: ì‚¬ìš©ëœ í…œí”Œë¦¿ ì‹ë³„ì
- `form_data`: ì›ë³¸ í¼ ë°ì´í„° (JSONB) - ì¬ìƒì„± ê°€ëŠ¥
- `html_url`: Storageì— ì €ì¥ëœ HTML íŒŒì¼ URL
- `html_content`: ë°±ì—…ìš© (ë§ˆì´ê·¸ë ˆì´ì…˜ ì „/í›„ í˜¸í™˜ì„±)

---

## ë‹¨ê³„ë³„ ì§„í–‰ ê³„íš

### ğŸ“… 5ë‹¨ê³„: ê¸°ë³¸ CRUD (í˜„ì¬)

**ëª©í‘œ**: ê°„ë‹¨í•œ ì „ë‹¨ì§€ CRUD ì™„ì„±

**êµ¬í˜„**:
- DBì— `html_content` ì§ì ‘ ì €ì¥
- ê°„ë‹¨í•œ í¼ ì…ë ¥ (ì œëª©, ì„¤ëª…, ì´ë¯¸ì§€)
- í…œí”Œë¦¿ ì—†ìŒ (ë‹¨ì¼ HTML ìƒì„± ë¡œì§)

**ìŠ¤í‚¤ë§ˆ**:
```sql
-- 5ë‹¨ê³„ì—ì„œëŠ” ìµœì†Œí•œë§Œ ì‚¬ìš©
create table public.flyers (
  ...
  title text not null,
  description text,
  html_content text not null,  -- ì—¬ê¸°ì— ì§ì ‘ ì €ì¥
  image_url text,
  ...
);
```

**ê¶Œì¥**: 5ë‹¨ê³„ì—ì„œ `form_data` ì»¬ëŸ¼ì„ **ë¯¸ë¦¬ ì¶”ê°€**í•˜ë©´ ì¢‹ìŒ
```sql
-- 5ë‹¨ê³„ ìŠ¤í‚¤ë§ˆì— ì¶”ê°€ (í–¥í›„ ëŒ€ë¹„)
alter table public.flyers
  add column if not exists template_id text not null default 'basic',
  add column if not exists form_data jsonb;

-- 5ë‹¨ê³„ì—ì„œëŠ” form_dataì— ê°„ë‹¨í•œ ë°ì´í„°ë§Œ ì €ì¥
-- {
--   "title": "...",
--   "description": "...",
--   "imageUrls": [...]
-- }
```

---

### ğŸ“… 7ë‹¨ê³„: í…œí”Œë¦¿ ì‹œìŠ¤í…œ ë„ì…

**ëª©í‘œ**: ë‹¤ì–‘í•œ í…œí”Œë¦¿ ì œê³µ

**êµ¬í˜„**:
1. í…œí”Œë¦¿ ì •ì˜:
   ```typescript
   // src/lib/templates/
   â”œâ”€â”€ BasicTemplate.tsx
   â”œâ”€â”€ EventTemplate.tsx
   â”œâ”€â”€ SaleTemplate.tsx
   â””â”€â”€ NoticeTemplate.tsx
   ```

2. í…œí”Œë¦¿ ì„ íƒ UI:
   ```typescript
   // FlyerForm.tsx
   <TemplateSelector
     value={selectedTemplate}
     onChange={setSelectedTemplate}
   />
   ```

3. í…œí”Œë¦¿ë³„ ì»¤ìŠ¤í…€ í•„ë“œ:
   ```typescript
   {selectedTemplate === 'event' && (
     <>
       <DatePicker label="ì´ë²¤íŠ¸ ë‚ ì§œ" />
       <Input label="ì¥ì†Œ" />
     </>
   )}
   ```

4. HTML ìƒì„± (ì•„ì§ DB ì €ì¥):
   ```typescript
   const template = templates[selectedTemplate];
   const htmlContent = template.render(formData);

   await supabase.from('flyers').insert({
     title: formData.title,
     template_id: selectedTemplate,
     form_data: formData,  // JSONB
     html_content: htmlContent,  // ì•„ì§ DBì— ì €ì¥
     ...
   });
   ```

---

### ğŸ“… 8ë‹¨ê³„: HTML Storage ë§ˆì´ê·¸ë ˆì´ì…˜ (ì´ ë¬¸ì„œ)

**ëª©í‘œ**: HTMLì„ Storageë¡œ ì´ê´€

**êµ¬í˜„**:
1. Storageì— HTML ì—…ë¡œë“œ ìœ í‹¸ë¦¬í‹° ì‘ì„±
2. `html_url` ì»¬ëŸ¼ í™œì„±í™”
3. ê¸°ì¡´ ì „ë‹¨ì§€ ë§ˆì´ê·¸ë ˆì´ì…˜
4. `html_content` ë°±ì—…ìš©ìœ¼ë¡œ ìœ ì§€ (ì‚­ì œ ê°€ëŠ¥)

**íƒ€ì´ë°**:
- í…œí”Œë¦¿ì´ 2~3ê°œ ì´ìƒì¼ ë•Œ
- HTML í‰ê·  í¬ê¸°ê°€ 10KB ì´ìƒì¼ ë•Œ
- í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ê°€ ìì£¼ í•„ìš”í•  ë•Œ

---

## í…œí”Œë¦¿ ì‹œìŠ¤í…œ ì›Œí¬í”Œë¡œìš° (8ë‹¨ê³„ ì ìš© í›„)

### 1. ì „ë‹¨ì§€ ìƒì„±

```typescript
// src/components/flyers/FlyerForm.tsx
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();

  // 1. í¼ ë°ì´í„° ì¤€ë¹„ (í…œí”Œë¦¿ë³„ í•„ë“œ í¬í•¨)
  const formData = {
    title: formState.title,
    description: formState.description,
    imageUrls: formState.imageUrls,
    // í…œí”Œë¦¿ë³„ ì»¤ìŠ¤í…€ í•„ë“œ
    ...(selectedTemplate === 'event' && {
      eventDate: formState.eventDate,
      location: formState.location,
    }),
    ...(selectedTemplate === 'sale' && {
      discountRate: formState.discountRate,
      originalPrice: formState.originalPrice,
    }),
  };

  // 2. í…œí”Œë¦¿ìœ¼ë¡œ HTML ìƒì„±
  const template = templates[selectedTemplate];
  const htmlContent = template.render(formData);

  // 3. DBì— ë¨¼ì € ì €ì¥ (uuid ë°›ê¸°)
  const { data: flyer, error } = await supabase
    .from('flyers')
    .insert({
      title: formData.title,
      description: formData.description,
      template_id: selectedTemplate,
      form_data: formData,  // JSONBë¡œ ì €ì¥
      html_content: htmlContent,  // ë°±ì—…ìš©
      image_url: formData.imageUrls[0],
      user_id: user.id,
    })
    .select('uuid')
    .single();

  if (error) throw error;

  // 4. HTMLì„ Storageì— ì—…ë¡œë“œ
  const { success, url } = await uploadHTMLToStorage({
    flyerUuid: flyer.uuid,
    htmlContent,
  });

  if (success) {
    // 5. html_url ì—…ë°ì´íŠ¸
    await supabase
      .from('flyers')
      .update({ html_url: url })
      .eq('uuid', flyer.uuid);
  }

  router.push('/');
};
```

### 2. ì „ë‹¨ì§€ ì¡°íšŒ

```typescript
// src/app/flyers/[id]/page.tsx
export default async function FlyerDetailPage({ params }: PageProps) {
  const supabase = createClient();

  const { data: flyer } = await supabase
    .from('flyers')
    .select('*, users(full_name, avatar_url)')
    .eq('uuid', params.id)
    .single();

  if (!flyer) notFound();

  // HTML ì¡°íšŒ (ìš°ì„ ìˆœìœ„: html_url > html_content)
  let htmlContent = '';

  if (flyer.html_url) {
    // Storageì—ì„œ ì¡°íšŒ
    htmlContent = await fetchHTMLFromStorage(flyer.html_url);
  }

  if (!htmlContent && flyer.html_content) {
    // ë°±ì—…: DBì—ì„œ ì¡°íšŒ
    htmlContent = flyer.html_content;
  }

  return (
    <article>
      <header>
        <h1>{flyer.title}</h1>
        <span className="badge">{flyer.template_id}</span>
      </header>
      <div dangerouslySetInnerHTML={{ __html: htmlContent }} />
    </article>
  );
}
```

### 3. í…œí”Œë¦¿ ì¬ìƒì„± (ê´€ë¦¬ì ê¸°ëŠ¥)

```typescript
// ì‚¬ìš©ìê°€ "ìµœì‹  í…œí”Œë¦¿ìœ¼ë¡œ ì—…ë°ì´íŠ¸" ë²„íŠ¼ í´ë¦­ ì‹œ
async function regenerateWithLatestTemplate(flyerUuid: string) {
  // 1. ì›ë³¸ ë°ì´í„° ì¡°íšŒ
  const { data: flyer } = await supabase
    .from('flyers')
    .select('template_id, form_data')
    .eq('uuid', flyerUuid)
    .single();

  // 2. ìµœì‹  í…œí”Œë¦¿ìœ¼ë¡œ ì¬ìƒì„±
  const template = templates[flyer.template_id];  // v2.0
  const newHTML = template.render(flyer.form_data);

  // 3. Storageì— ì—…ë¡œë“œ (ë®ì–´ì“°ê¸°)
  const { url } = await uploadHTMLToStorage({
    flyerUuid,
    htmlContent: newHTML,
  });

  // 4. DB ì—…ë°ì´íŠ¸
  await supabase
    .from('flyers')
    .update({
      html_url: url,
      html_content: newHTML,  // ë°±ì—…ë„ ì—…ë°ì´íŠ¸
      updated_at: new Date().toISOString(),
    })
    .eq('uuid', flyerUuid);
}
```

---

## êµ¬í˜„ ê³„íš (8ë‹¨ê³„ ì§„í–‰ ì‹œ)

> [!CAUTION]
> ì´ ì„¹ì…˜ì€ **7ë‹¨ê³„(í…œí”Œë¦¿ ì‹œìŠ¤í…œ) ì™„ë£Œ í›„** ì§„í–‰í•˜ì„¸ìš”.

### 1. Storage ë²„í‚· ì„¤ì •

**í´ë” êµ¬ì¡°**:
```
flyers (bucket)
â”œâ”€â”€ images/                 # ì´ë¯¸ì§€ íŒŒì¼
â”‚   â””â”€â”€ <userId>/
â”‚       â””â”€â”€ <timestamp>_<uuid>.jpg
â””â”€â”€ html/                   # HTML íŒŒì¼
    â””â”€â”€ <flyerUuid>.html
```

### 2. HTML Storage ìœ í‹¸ë¦¬í‹°

#### [ì‹ ê·œ] `src/lib/storage/html-storage.ts`

```typescript
import { createClient } from '@/lib/supabase/client';

interface UploadHTMLParams {
  flyerUuid: string;
  htmlContent: string;
}

interface UploadHTMLResult {
  success: boolean;
  url?: string;
  error?: string;
}

/**
 * HTML ì½˜í…ì¸ ë¥¼ Storageì— íŒŒì¼ë¡œ ì—…ë¡œë“œ
 */
export async function uploadHTMLToStorage({
  flyerUuid,
  htmlContent,
}: UploadHTMLParams): Promise<UploadHTMLResult> {
  try {
    const supabase = createClient();

    // HTMLì„ Blobìœ¼ë¡œ ë³€í™˜
    const blob = new Blob([htmlContent], {
      type: 'text/html; charset=utf-8'
    });

    // íŒŒì¼ ê²½ë¡œ
    const filePath = `html/${flyerUuid}.html`;

    // Storageì— ì—…ë¡œë“œ
    const { error: uploadError } = await supabase.storage
      .from('flyers')
      .upload(filePath, blob, {
        contentType: 'text/html',
        upsert: true, // ë®ì–´ì“°ê¸° í—ˆìš© (ì¬ìƒì„± ì‹œ)
        cacheControl: '3600', // 1ì‹œê°„ ìºì‹œ
      });

    if (uploadError) throw uploadError;

    // Public URL ìƒì„±
    const { data: { publicUrl } } = supabase.storage
      .from('flyers')
      .getPublicUrl(filePath);

    return { success: true, url: publicUrl };
  } catch (error) {
    console.error('HTML upload failed:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Upload failed',
    };
  }
}

/**
 * Storageì—ì„œ HTML íŒŒì¼ ì¡°íšŒ
 */
export async function fetchHTMLFromStorage(url: string): Promise<string | null> {
  try {
    const response = await fetch(url, {
      cache: 'force-cache', // ìºì‹± í™œìš©
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    return await response.text();
  } catch (error) {
    console.error('HTML fetch failed:', error);
    return null;
  }
}

/**
 * Storageì—ì„œ HTML íŒŒì¼ ì‚­ì œ
 */
export async function deleteHTMLFromStorage(flyerUuid: string): Promise<boolean> {
  try {
    const supabase = createClient();
    const filePath = `html/${flyerUuid}.html`;

    const { error } = await supabase.storage
      .from('flyers')
      .remove([filePath]);

    if (error) throw error;
    return true;
  } catch (error) {
    console.error('HTML delete failed:', error);
    return false;
  }
}
```

### 3. ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸

#### [ì‹ ê·œ] `scripts/migrate-html-to-storage.ts`

```typescript
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // ì„œë¹„ìŠ¤ í‚¤ í•„ìš”
);

async function migrateHTMLToStorage() {
  console.log('Starting HTML migration to Storage...\n');

  // 1. html_urlì´ ì—†ëŠ” ì „ë‹¨ì§€ ì¡°íšŒ
  const { data: flyers, error } = await supabase
    .from('flyers')
    .select('uuid, html_content, template_id')
    .is('html_url', null)
    .not('html_content', 'is', null);

  if (error || !flyers) {
    console.error('Failed to fetch flyers:', error);
    return;
  }

  console.log(`Found ${flyers.length} flyers to migrate\n`);

  let successCount = 0;
  let failCount = 0;

  for (const flyer of flyers) {
    try {
      // 2. HTMLì„ Storageì— ì—…ë¡œë“œ
      const blob = new Blob([flyer.html_content], {
        type: 'text/html; charset=utf-8',
      });

      const filePath = `html/${flyer.uuid}.html`;

      const { error: uploadError } = await supabase.storage
        .from('flyers')
        .upload(filePath, blob, {
          contentType: 'text/html',
          upsert: true,
        });

      if (uploadError) throw uploadError;

      // 3. Public URL ìƒì„±
      const { data: { publicUrl } } = supabase.storage
        .from('flyers')
        .getPublicUrl(filePath);

      // 4. DB ì—…ë°ì´íŠ¸
      const { error: updateError } = await supabase
        .from('flyers')
        .update({ html_url: publicUrl })
        .eq('uuid', flyer.uuid);

      if (updateError) throw updateError;

      successCount++;
      console.log(`âœ“ Migrated [${flyer.template_id}]: ${flyer.uuid}`);
    } catch (err) {
      failCount++;
      console.error(`âœ— Failed: ${flyer.uuid}`, err);
    }
  }

  console.log(`\n=== Migration Complete ===`);
  console.log(`Success: ${successCount}`);
  console.log(`Failed: ${failCount}`);
  console.log(`Total: ${flyers.length}`);
}

migrateHTMLToStorage();
```

**ì‹¤í–‰**:
```bash
# tsx ì„¤ì¹˜ (ì—†ì„ ê²½ìš°)
npm install -D tsx

# ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
npx tsx scripts/migrate-html-to-storage.ts
```

---

## ê²€ì¦ ê³„íš

### 1. ìƒì„± í…ŒìŠ¤íŠ¸

**ì‹œë‚˜ë¦¬ì˜¤**:
1. ìƒˆ ì „ë‹¨ì§€ ì‘ì„± (í…œí”Œë¦¿ ì„ íƒ: Event)
2. ì´ë²¤íŠ¸ë³„ í•„ë“œ ì…ë ¥ (ë‚ ì§œ, ì¥ì†Œ ë“±)
3. ì €ì¥ í›„ í™•ì¸

**ê²€ì¦**:
```sql
-- DB í™•ì¸
select
  uuid,
  title,
  template_id,
  form_data,
  html_url,
  length(html_content) as html_backup_size
from flyers
order by created_at desc
limit 1;

-- form_data í™•ì¸
select form_data->>'eventDate' as event_date,
       form_data->>'location' as location
from flyers
where template_id = 'event'
limit 1;
```

**Storage í™•ì¸**:
- Supabase Dashboard â†’ Storage â†’ flyers â†’ html
- `<uuid>.html` íŒŒì¼ ì¡´ì¬ í™•ì¸

### 2. ì¡°íšŒ í…ŒìŠ¤íŠ¸

**ì‹œë‚˜ë¦¬ì˜¤**:
1. ìƒì„¸ í˜ì´ì§€ ì ‘ì†
2. HTML ì •ìƒ ë Œë”ë§ í™•ì¸
3. í…œí”Œë¦¿ ìŠ¤íƒ€ì¼ ì ìš© í™•ì¸

**ë„¤íŠ¸ì›Œí¬ í™•ì¸**:
- DevTools â†’ Network
- Storage HTML íŒŒì¼ fetch í™•ì¸ (200 OK)
- ìºì‹± í—¤ë” í™•ì¸

### 3. ì¬ìƒì„± í…ŒìŠ¤íŠ¸

**ì‹œë‚˜ë¦¬ì˜¤**:
1. í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ (EventTemplate v2.0)
2. ê¸°ì¡´ ì „ë‹¨ì§€ì—ì„œ "ìµœì‹  í…œí”Œë¦¿ìœ¼ë¡œ ì—…ë°ì´íŠ¸" í´ë¦­
3. Storage íŒŒì¼ ë®ì–´ì“°ê¸° í™•ì¸

**ê²€ì¦**:
```sql
-- updated_at í™•ì¸
select uuid, template_id, updated_at
from flyers
where uuid = '<í…ŒìŠ¤íŠ¸-uuid>';
```

### 4. ì‚­ì œ í…ŒìŠ¤íŠ¸

**ì‹œë‚˜ë¦¬ì˜¤**:
1. ì „ë‹¨ì§€ ì‚­ì œ
2. DB ë ˆì½”ë“œ ì‚­ì œ í™•ì¸
3. Storage íŒŒì¼ë„ ì‚­ì œ í™•ì¸

```sql
-- Storage ê°ì²´ í™•ì¸
select * from storage.objects
where bucket_id = 'flyers'
  and name like 'html/%'
order by created_at desc;
```

### 5. í…œí”Œë¦¿ë³„ ê²€ì¦

**ì‹œë‚˜ë¦¬ì˜¤**:
- Basic í…œí”Œë¦¿: ê°„ë‹¨í•œ HTML
- Event í…œí”Œë¦¿: ë³µì¡í•œ HTML + ì»¤ìŠ¤í…€ í•„ë“œ
- Sale í…œí”Œë¦¿: ê°€ê²© ì •ë³´ í¬í•¨

**í™•ì¸**:
```sql
-- í…œí”Œë¦¿ë³„ í‰ê·  HTML í¬ê¸°
select
  template_id,
  count(*) as count,
  avg(length(html_content)) as avg_html_size,
  max(length(html_content)) as max_html_size
from flyers
group by template_id;
```

---

## ë¡¤ë°± ë°©ë²•

### 1. ì½”ë“œ ë¡¤ë°±

```typescript
// FlyerForm.tsx
// Storage ì—…ë¡œë“œ ë¡œì§ ì œê±°, html_contentë§Œ ì €ì¥

// ìƒì„¸ í˜ì´ì§€
// fetch ë¡œì§ ì œê±°, html_content ì§ì ‘ ì‚¬ìš©
```

### 2. DB ë¡¤ë°±

```sql
-- html_url ì‚¬ìš© ì¤‘ì§€ (ì»¬ëŸ¼ì€ ìœ ì§€)
-- html_contentë¡œ ëŒ€ì²´

-- í•„ìš” ì‹œ html_url ì»¬ëŸ¼ ì‚­ì œ
alter table public.flyers
  drop column if exists html_url;
```

### 3. Storage ì •ë¦¬

```bash
# ëª¨ë“  HTML íŒŒì¼ ì‚­ì œ (Supabase Dashboard ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸)
```

---

## ì¥ë‹¨ì  ë¹„êµ (í…œí”Œë¦¿ ì‹œìŠ¤í…œ ê´€ì )

### DB ì €ì¥ (html_content)

**ì¥ì **:
- âœ… ê°„ë‹¨í•œ êµ¬ì¡°
- âœ… í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ì¡°íšŒ
- âœ… íŠ¸ëœì­ì…˜ ë³´ì¥

**ë‹¨ì **:
- âŒ í…œí”Œë¦¿ê³¼ ë°ì´í„° ë¶„ë¦¬ ì•ˆ ë¨
- âŒ ì¬ìƒì„± ì–´ë ¤ì›€
- âŒ ë³µì¡í•œ í…œí”Œë¦¿ ì‹œ DB ìš©ëŸ‰ ì¦ê°€
- âŒ í…œí”Œë¦¿ ë²„ì „ ê´€ë¦¬ ë¶ˆê°€

### Storage ì €ì¥ (html_url)

**ì¥ì **:
- âœ… ë°ì´í„°(form_data)ì™€ ê²°ê³¼(HTML) ë¶„ë¦¬
- âœ… í…œí”Œë¦¿ ì¬ìƒì„± ê°€ëŠ¥
- âœ… ë²„ì „ ê´€ë¦¬ ìš©ì´
- âœ… ë³µì¡í•œ HTML íš¨ìœ¨ì  ì²˜ë¦¬
- âœ… CDN í™œìš© ê°€ëŠ¥

**ë‹¨ì **:
- âŒ ì¶”ê°€ ë„¤íŠ¸ì›Œí¬ ìš”ì²­
- âŒ ë³µì¡ë„ ì¦ê°€
- âŒ Storageì™€ DB ì¼ê´€ì„± ìœ ì§€ í•„ìš”

---

## ì„±ëŠ¥ ë¹„êµ

### Before (DB ì €ì¥)

**ì¡°íšŒ**:
- DB ì¿¼ë¦¬: ~50ms
- ì´: ~50ms

**ì €ì¥**:
- DB INSERT: ~30ms
- ì´: ~30ms

### After (Storage ì €ì¥)

**ì¡°íšŒ**:
- DB ì¿¼ë¦¬: ~50ms
- Storage fetch: ~100ms (ìºì‹± ì‹œ ~10ms)
- ì´: ~150ms (ì²« ì¡°íšŒ), ~60ms (ìºì‹±)

**ì €ì¥**:
- DB INSERT: ~30ms
- Storage ì—…ë¡œë“œ: ~200ms
- DB UPDATE: ~30ms
- ì´: ~260ms

**ê²°ë¡ **:
- ì²« ì¡°íšŒ ì‹œ ëŠë¦¬ì§€ë§Œ ìºì‹±ìœ¼ë¡œ ê°œì„ 
- í…œí”Œë¦¿ ì‹œìŠ¤í…œì˜ ì¥ì ì´ ì„±ëŠ¥ ë‹¨ì ì„ ìƒì‡„

---

## ìµœì¢… ê¶Œì¥ì‚¬í•­

### âœ… ì§„í–‰ ê¶Œì¥

**ë‹¤ìŒ ê²½ìš° 8ë‹¨ê³„ ì§„í–‰**:
1. í…œí”Œë¦¿ ì‹œìŠ¤í…œ ë„ì… ì™„ë£Œ (7ë‹¨ê³„)
2. í…œí”Œë¦¿ì´ 2ê°œ ì´ìƒ
3. í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ê°€ ì˜ˆìƒë¨
4. ë³µì¡í•œ HTML (10KB+)

### ğŸ“‹ ì§„í–‰ ìˆœì„œ

1. **5ë‹¨ê³„**: ê¸°ë³¸ CRUD
   - DBì— `html_content` ì €ì¥
   - `form_data` ì»¬ëŸ¼ ë¯¸ë¦¬ ì¶”ê°€ ê¶Œì¥

2. **6ë‹¨ê³„**: UI/UX ê°œì„ 

3. **7ë‹¨ê³„**: í…œí”Œë¦¿ ì‹œìŠ¤í…œ ë„ì…
   - 2~3ê°œ í…œí”Œë¦¿ ì œì‘
   - ì—¬ì „íˆ `html_content` ì‚¬ìš©
   - `template_id` í™œì„±í™”

4. **8ë‹¨ê³„**: Storage ë§ˆì´ê·¸ë ˆì´ì…˜
   - `html_url` í™œì„±í™”
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
   - `html_content` ë°±ì—…ìš© ìœ ì§€

### ğŸ’¡ 5ë‹¨ê³„ì—ì„œ ë¯¸ë¦¬ ì¤€ë¹„

```sql
-- 5ë‹¨ê³„ ìŠ¤í‚¤ë§ˆì— ì¶”ê°€ ê¶Œì¥
alter table public.flyers
  add column if not exists template_id text not null default 'basic',
  add column if not exists form_data jsonb not null default '{}'::jsonb;

-- ì¸ë±ìŠ¤
create index if not exists flyers_template_id_idx
  on public.flyers(template_id);
```

ì´ë ‡ê²Œ í•˜ë©´ 7ë‹¨ê³„, 8ë‹¨ê³„ ì§„í–‰ ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¶€ë‹´ ê°ì†Œ!
