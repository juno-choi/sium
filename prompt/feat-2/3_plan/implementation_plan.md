# 멀티 캐릭터 구매 및 관리 시스템 구현 계획

## 목표
상점에서 골드를 사용하여 새로운 캐릭터를 구매하고, 여러 캐릭터를 독립적으로 육성할 수 있는 기능 구현

## 현재 상태 분석

### 기존 스키마 (`user_characters` 테이블)
```sql
create table public.user_characters (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users(id) on delete cascade not null unique,  -- ← 유저 1명당 캐릭터 1개로 제한됨
  character_id int references public.characters(id) not null,
  current_xp int default 0,
  current_level int default 1,
  gold int default 0,
  ...
);
```

현재 `user_id`가 **unique**로 설정되어 있어 유저당 캐릭터를 하나만 가질 수 있습니다.

---

## User Review Required

> [!WARNING]
> **골드 관리 위치 변경**: 현재 골드가 `user_characters` 테이블에 캐릭터별로 관리되고 있습니다.  
> 멀티 캐릭터 구현 시 **골드를 유저 공통 자산으로 분리**할지, **캐릭터별로 유지**할지 결정이 필요합니다.  
> - **(A) 유저 공통 골드**: `public.users` 테이블에 `gold` 컬럼 추가
> - **(B) 캐릭터별 골드 유지**: 각 캐릭터가 독립적으로 골드 보유 (장비도 캐릭터별로 분리 필요)
> 
> 아래 계획은 **(A) 유저 공통 골드** 방식을 가정하고 작성되었습니다.

---

## Proposed Changes

### 1. Database Schema 수정

#### [MODIFY] [schema.sql](file:///c:/project/personal/2025/sium/supabase/schema.sql)

**변경 사항:**
1. `user_characters` 테이블에서 `unique` 제약 조건 제거
2. `is_active` 컬럼 추가 (현재 활성화된 캐릭터 표시)
3. `gold` 컬럼을 `public.users` 테이블로 이동
4. `characters` 테이블에 `price` 컬럼 추가 (캐릭터 구매 가격)

```diff
-- users 테이블에 gold 추가
create table if not exists public.users (
  id bigint generated by default as identity primary key,
  uuid uuid references auth.users not null unique,
  email text,
  full_name text,
  avatar_url text,
+ gold int default 0 not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- characters 테이블에 가격 추가
create table public.characters (
  id serial primary key,
  name varchar(50) not null,
  description text,
  base_image_url varchar(255),
+ price int default 0 not null,  -- 0이면 무료 (기본 캐릭터)
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- user_characters 테이블 수정
create table public.user_characters (
  id uuid default uuid_generate_v4() primary key,
- user_id uuid references auth.users(id) on delete cascade not null unique,
+ user_id uuid references auth.users(id) on delete cascade not null,
  character_id int references public.characters(id) not null,
  current_xp int default 0 not null,
  current_level int default 1 not null,
- gold int default 0 not null,
+ is_active boolean default false not null,  -- 현재 사용 중인 캐릭터
  hair_style varchar(50) default 'short' not null,
  face_shape varchar(50) default 'smiling' not null,
  skin_color varchar(20) default '#FFDAB9' not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null,
+ unique(user_id, character_id)  -- 같은 캐릭터 중복 구매 방지
);
```

---

### 2. Types 수정

#### [MODIFY] [character.ts](file:///c:/project/personal/2025/sium/src/types/character.ts)

```diff
export interface Character {
    id: number;
    name: string;
    description: string;
    base_image_url: string;
+   price: number;
    created_at: string;
}

export interface UserCharacter {
    id: string;
    user_id: string;
    character_id: number;
    current_xp: number;
    current_level: number;
-   gold: number;
+   is_active: boolean;
    // ...
}
+
+ export interface UserProfile {
+     id: number;
+     uuid: string;
+     email: string;
+     full_name: string;
+     avatar_url: string;
+     gold: number;
+ }
```

---

### 3. CharacterProvider 수정

#### [MODIFY] [CharacterProvider.tsx](file:///c:/project/personal/2025/sium/src/components/providers/CharacterProvider.tsx)

**변경 사항:**
1. 여러 캐릭터를 관리하는 `userCharacters` 목록 추가
2. `activeCharacter`로 현재 활성 캐릭터 분리
3, 골드를 별도 상태로 관리
4. 캐릭터 전환 함수 `switchCharacter` 추가
5. 캐릭터 구매 함수 `buyCharacter` 추가

---

### 4. Shop 페이지에 캐릭터 탭 추가

#### [MODIFY] [page.tsx (shop)](file:///c:/project/personal/2025/sium/src/app/shop/page.tsx)

**변경 사항:**
1. "장비" / "캐릭터" 탭 추가
2. 캐릭터 탭에서 `characters` 테이블의 캐릭터 목록 표시
3. 이미 보유한 캐릭터는 "보유 중" 표시
4. 골드로 새 캐릭터 구매 가능

---

### 5. 캐릭터 전환 UI 추가

#### [NEW] [character-switch](file:///c:/project/personal/2025/sium/src/components/character/CharacterSwitch.tsx)

Header 또는 Dashboard에 캐릭터 전환 드롭다운/모달 추가

---

### 6. useShop 훅 수정

#### [MODIFY] [useShop.ts](file:///c:/project/personal/2025/sium/src/lib/hooks/useShop.ts)

캐릭터 구매 함수 추가:
```typescript
const buyCharacter = async (characterId: number, price: number) => {
    // 1. 골드 차감 (users 테이블)
    // 2. user_characters에 새 캐릭터 추가 (level 1, xp 0)
    // 3. 상태 갱신
};
```

---

## Verification Plan

### Manual Verification

현재 프로젝트에 자동화된 테스트가 없으므로, 아래 수동 테스트를 수행합니다:

1. **캐릭터 구매 테스트**
   - 상점 페이지 → "캐릭터" 탭 클릭
   - 구매 가능한 캐릭터 선택 → 구매 버튼 클릭
   - 골드가 차감되고, 캐릭터가 보유 목록에 추가되는지 확인

2. **캐릭터 전환 테스트**
   - 헤더 또는 대시보드에서 캐릭터 전환 UI 클릭
   - 다른 캐릭터 선택 후 전환
   - 전환된 캐릭터의 레벨/XP가 정상 표시되는지 확인

3. **독립적 레벨 관리 테스트**
   - 캐릭터 A로 퀘스트 완료 → XP 증가 확인
   - 캐릭터 B로 전환 → 캐릭터 B의 XP는 변화 없음 확인
   - 다시 캐릭터 A로 전환 → 기존 XP 유지 확인

4. **골드 공유 테스트**
   - 캐릭터 A로 퀘스트 완료 → 골드 증가
   - 캐릭터 B로 전환 → 동일한 골드가 표시되는지 확인

---

## 구현 순서

1. **스키마 마이그레이션 스크립트 작성** (Supabase SQL)
2. **Types 업데이트**
3. **CharacterProvider 리팩토링**
4. **useShop 훅에 캐릭터 구매 함수 추가**
5. **상점 페이지에 캐릭터 탭 UI 구현**
6. **캐릭터 전환 UI 컴포넌트 구현**
7. **수동 테스트 수행**
