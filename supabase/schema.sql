-- Enable the UUID extension
create extension if not exists "uuid-ossp";

-- Reset (Drop existing tables if they exist)
drop table if exists public.users;
drop table if exists public.habit_logs;
drop table if exists public.habits;
drop table if exists public.user_characters;
drop table if exists public.character_evolutions;
drop table if exists public.characters;
drop table if exists public.flyers; -- Old table
drop type if exists habit_difficulty;

-- 1. Users table (Public profile) - Mirroring Supabase Auth
create table if not exists public.users (
  id bigint generated by default as identity primary key,
  uuid uuid references auth.users not null unique,
  email text,
  full_name text,
  avatar_url text,
  gold int default 0 not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.users enable row level security;
create policy "Public profiles are viewable by everyone." on public.users for select using (true);
create policy "Users can insert their own profile." on public.users for insert with check (auth.uid() = uuid);
create policy "Users can update own profile." on public.users for update using (auth.uid() = uuid);

-- 2. Characters Master Table (with Level Images)
create table public.characters (
  id serial primary key,
  name varchar(50) not null,
  description text,
  base_image_url varchar(255),
  level_images jsonb default '{}' not null, -- {"1": "img1.png", "10": "img10.png", "20": "img20.png"}
  price int default 0 not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.characters enable row level security;
create policy "Characters are viewable by everyone." on public.characters for select using (true);

-- 3. User Characters (Selected character, progress)
create table public.user_characters (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users(id) on delete cascade not null,
  character_id int references public.characters(id) not null,
  current_xp int default 0 not null,
  current_level int default 1 not null,
  is_active boolean default false not null,
  
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(user_id, character_id)
);

alter table public.user_characters enable row level security;
create policy "Users can view own character progress." on public.user_characters for select using (auth.uid() = user_id);
create policy "Users can choose their character." on public.user_characters for insert with check (auth.uid() = user_id);
create policy "Users can update own character progress." on public.user_characters for update using (auth.uid() = user_id);

-- 4. Habits Table
create type habit_difficulty as enum ('easy', 'normal', 'hard');

create table public.habits (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users(id) on delete cascade not null,
  title varchar(100) not null,
  description text,
  difficulty habit_difficulty default 'normal' not null,
  mon boolean default false,
  tue boolean default false,
  wed boolean default false,
  thu boolean default false,
  fri boolean default false,
  sat boolean default false,
  sun boolean default false,
  is_active boolean default true not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.habits enable row level security;
create policy "Users can manage own habits." on public.habits for all using (auth.uid() = user_id);

-- 5. Habit Logs (with Gold tracking)
create table public.habit_logs (
  id uuid default uuid_generate_v4() primary key,
  habit_id uuid references public.habits(id) on delete cascade not null,
  user_id uuid references auth.users(id) on delete cascade not null,
  completed_date date default current_date not null,
  xp_earned int not null,
  gold_earned int default 0 not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(habit_id, completed_date)
);

alter table public.habit_logs enable row level security;
create policy "Users can view/insert/delete own logs." on public.habit_logs for all using (auth.uid() = user_id);

-- 6. Initial Seed Data (Characters with Level Images)
insert into public.characters (name, description, base_image_url, level_images) values
('전사', '강인한 체력과 용기를 가진 모험가입니다.', 'warrior_lv1.png', '{"1": "warrior_lv1.png", "10": "warrior_lv10.png", "20": "warrior_lv20.png"}'),
('마법사', '신비로운 마력을 사용하는 지혜로운 탐구자입니다.', 'mage_lv1.png', '{"1": "mage_lv1.png", "10": "mage_lv10.png", "20": "mage_lv20.png"}'),
('궁수', '날렵한 몸놀림으로 목표를 꿰뚫는 사냥꾼입니다.', 'archer_lv1.png', '{"1": "archer_lv1.png", "10": "archer_lv10.png", "20": "archer_lv20.png"}');

-- 7. Functions & Triggers (Sync users)
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.users (uuid, email, full_name, avatar_url)
  values (
    new.id,
    new.email,
    coalesce(new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'name', ''),
    new.raw_user_meta_data->>'avatar_url'
  )
  on conflict (uuid) do update
  set email = excluded.email, full_name = excluded.full_name, avatar_url = excluded.avatar_url, updated_at = now();
  return new;
end;
$$ language plpgsql security definer;

drop trigger if exists on_auth_user_created on auth.users;
create trigger on_auth_user_created after insert on auth.users for each row execute procedure public.handle_new_user();

create table public.daily_habits (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users(id) on delete cascade not null,
  title varchar(100) not null,
  description text,
  difficulty habit_difficulty default 'normal' not null,
  quest_date date default current_date not null,
  is_active boolean default true not null,
  created_at timestamp with time zone default now() not null
);
alter table public.daily_habits enable row level security;
create policy "Users can manage own daily habits." 
  on public.daily_habits for all using (auth.uid() = user_id);

  -- daily_habit_logs 테이블 추가
create table if not exists public.daily_habit_logs (
  id uuid default uuid_generate_v4() primary key,
  daily_habit_id uuid references public.daily_habits(id) on delete cascade not null,
  user_id uuid references auth.users(id) on delete cascade not null,
  completed_date date default current_date not null,
  xp_earned int not null,
  gold_earned int default 0 not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(daily_habit_id, completed_date)
);
alter table public.daily_habit_logs enable row level security;
create policy "Users can manage own daily habit logs." 
  on public.daily_habit_logs for all using (auth.uid() = user_id);

  -- RLS 활성화 (이미 활성화되어 있을 가능성 높음)
ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

-- 정책 1: 인증된 사용자는 assets bucket의 파일을 읽을 수 있음
  CREATE POLICY "Allow authenticated users to view buckets"
ON storage.buckets FOR SELECT
TO authenticated
USING (true);

CREATE POLICY "Allow authenticated users to select files"
ON storage.objects FOR SELECT
TO authenticated
USING (bucket_id = 'assets');