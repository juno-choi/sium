-- Enable the UUID extension
create extension if not exists "uuid-ossp";

-- Reset (Drop existing tables if they exist)
drop table if exists public.user_equipment;
drop table if exists public.equipment_items;
drop table if exists public.customization_options;
drop table if exists public.habit_logs;
drop table if exists public.habits;
drop table if exists public.user_characters;
drop table if exists public.character_evolutions;
drop table if exists public.characters;
drop table if exists public.flyers; -- Old table
drop type if exists habit_difficulty;

-- 1. Users table (Public profile) - Mirroring Supabase Auth
create table if not exists public.users (
  id bigint generated by default as identity primary key,
  uuid uuid references auth.users not null unique,
  email text,
  full_name text,
  avatar_url text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.users enable row level security;
create policy "Public profiles are viewable by everyone." on public.users for select using (true);
create policy "Users can insert their own profile." on public.users for insert with check (auth.uid() = uuid);
create policy "Users can update own profile." on public.users for update using (auth.uid() = uuid);

-- 2. Characters Master Table (Humanoid focus)
create table public.characters (
  id serial primary key,
  name varchar(50) not null,
  description text,
  base_image_url varchar(255), -- "human_male", "human_female" etc.
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.characters enable row level security;
create policy "Characters are viewable by everyone." on public.characters for select using (true);

-- 3. User Characters (Selected character, progress, gold, and appearance)
create table public.user_characters (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users(id) on delete cascade not null unique,
  character_id int references public.characters(id) not null,
  current_xp int default 0 not null,
  current_level int default 1 not null,
  gold int default 0 not null,
  
  -- Customization
  hair_style varchar(50) default 'plain' not null,
  face_shape varchar(50) default 'smiling' not null,
  skin_color varchar(20) default '#FFDAB9' not null,
  
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.user_characters enable row level security;
create policy "Users can view own character progress." on public.user_characters for select using (auth.uid() = user_id);
create policy "Users can choose their character." on public.user_characters for insert with check (auth.uid() = user_id);
create policy "Users can update own character progress." on public.user_characters for update using (auth.uid() = user_id);

-- 4. Equipment Items Master
create table public.equipment_items (
  id serial primary key,
  name varchar(100) not null,
  slot varchar(30) not null, -- 'hat', 'top', 'bottom', 'shoes', 'gloves', 'face_accessory'
  image_url varchar(255),
  price int not null default 0,
  description text,
  rarity varchar(20) default 'common' not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.equipment_items enable row level security;
create policy "Equipment is viewable by everyone." on public.equipment_items for select using (true);

-- 5. User Owned Equipment
create table public.user_equipment (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users(id) on delete cascade not null,
  item_id int references public.equipment_items(id) not null,
  is_equipped boolean default false not null,
  purchased_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(user_id, item_id)
);

alter table public.user_equipment enable row level security;
create policy "Users can view/manage own equipment." on public.user_equipment for all using (auth.uid() = user_id);

-- 6. Customization Options Master
create table public.customization_options (
  id serial primary key,
  category varchar(20) not null, -- 'hair', 'face', 'skin'
  name varchar(50) not null,
  value varchar(100) not null,
  price int default 0 not null,
  is_default boolean default false not null
);

alter table public.customization_options enable row level security;
create policy "Options viewable by everyone." on public.customization_options for select using (true);

-- 7. Habits Table
create type habit_difficulty as enum ('easy', 'normal', 'hard');

create table public.habits (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users(id) on delete cascade not null,
  title varchar(100) not null,
  description text,
  difficulty habit_difficulty default 'normal' not null,
  mon boolean default false,
  tue boolean default false,
  wed boolean default false,
  thu boolean default false,
  fri boolean default false,
  sat boolean default false,
  sun boolean default false,
  is_active boolean default true not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.habits enable row level security;
create policy "Users can manage own habits." on public.habits for all using (auth.uid() = user_id);

-- 8. Habit Logs (Now with Gold tracking)
create table public.habit_logs (
  id uuid default uuid_generate_v4() primary key,
  habit_id uuid references public.habits(id) on delete cascade not null,
  user_id uuid references auth.users(id) on delete cascade not null,
  completed_date date default current_date not null,
  xp_earned int not null,
  gold_earned int default 0 not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(habit_id, completed_date)
);

alter table public.habit_logs enable row level security;
create policy "Users can view/insert/delete own logs." on public.habit_logs for all using (auth.uid() = user_id);

-- 9. Initial Seed Data
insert into public.characters (name, description, base_image_url) values
('ì „ì‚¬', 'ê°•ì¸í•œ ì²´ë ¥ê³¼ ìš©ê¸°ë¥¼ ê°€ì§„ ëª¨í—˜ê°€ìž…ë‹ˆë‹¤.', 'ðŸ§‘â€ðŸš€'),
('ë§ˆë²•ì‚¬', 'ì‹ ë¹„ë¡œìš´ ë§ˆë ¥ì„ ì‚¬ìš©í•˜ëŠ” ì§€í˜œë¡œìš´ íƒêµ¬ìžìž…ë‹ˆë‹¤.', 'ðŸ§™'),
('ê¶ìˆ˜', 'ë‚ ë µí•œ ëª¸ë†€ë¦¼ìœ¼ë¡œ ëª©í‘œë¥¼ ê¿°ëš«ëŠ” ì‚¬ëƒ¥ê¾¼ìž…ë‹ˆë‹¤.', 'ðŸ§');

-- Basic Equipment Items
insert into public.equipment_items (name, slot, price, rarity, description, image_url) values
('ë‚¡ì€ ê°€ì£½ ëª¨ìž', 'hat', 100, 'common', 'í–‡ë³•ì„ ê°€ë ¤ì£¼ëŠ” í‰ë²”í•œ ê°€ì£½ ëª¨ìžìž…ë‹ˆë‹¤.', 'ðŸ‘’'),
('ìˆ˜ë ¨ìš© ê°‘ì˜·', 'top', 300, 'common', 'ê¸°ë³¸ì ì¸ ë°©ì–´ë ¥ì„ ê°–ì¶˜ ìˆ˜ë ¨ìš© ìƒì˜ìž…ë‹ˆë‹¤.', 'ðŸ‘•'),
('íŠ¼íŠ¼í•œ ë°”ì§€', 'bottom', 200, 'common', 'ê±°ì¹œ ëª¨í—˜ì—ë„ ë„ë–¡ì—†ëŠ” ë°”ì§€ìž…ë‹ˆë‹¤.', 'ðŸ‘–'),
('ëª¨í—˜ê°€ì˜ ìž¥í™”', 'shoes', 150, 'common', 'ì˜¤ëž˜ ê±¸ì–´ë„ ë°œì´ íŽ¸ì•ˆí•œ ìž¥í™”ìž…ë‹ˆë‹¤.', 'ðŸ‘ž'),
('ê°€ì£½ ìž¥ê°‘', 'gloves', 100, 'common', 'ì†ì„ ë³´í˜¸í•´ì£¼ëŠ” íŠ¼íŠ¼í•œ ê°€ì£½ ìž¥ê°‘ìž…ë‹ˆë‹¤.', 'ðŸ§¤'),
('ë©‹ì§„ ì•ˆê²½', 'face_accessory', 500, 'rare', 'ì§€ì ì¸ ëŠë‚Œì„ ì£¼ëŠ” ê¸ˆí…Œ ì•ˆê²½ìž…ë‹ˆë‹¤.', 'ðŸ‘“');

-- Customization Options
insert into public.customization_options (category, name, value, price, is_default) values
('hair', 'ìˆì»·', 'short', 0, true),
('hair', 'ë¡±í—¤ì–´', 'long', 500, false),
('hair', 'ëª¨ížˆì¹¸', 'mohawk', 800, false),
('face', 'ì›ƒëŠ” ì–¼êµ´', 'smiling', 0, true),
('face', 'ì§„ì§€í•œ ì–¼êµ´', 'serious', 300, false),
('skin', 'ì‚´êµ¬ìƒ‰', '#FFDAB9', 0, true),
('skin', 'í° í”¼ë¶€', '#FFFFFF', 1000, false),
('skin', 'ê·¸ì„ë¦° í”¼ë¶€', '#D2B48C', 500, false);

-- 10. Functions & Triggers (Sync users)
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.users (uuid, email, full_name, avatar_url)
  values (
    new.id,
    new.email,
    coalesce(new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'name', ''),
    new.raw_user_meta_data->>'avatar_url'
  )
  on conflict (uuid) do update
  set email = excluded.email, full_name = excluded.full_name, avatar_url = excluded.avatar_url, updated_at = now();
  return new;
end;
$$ language plpgsql security definer;

drop trigger if exists on_auth_user_created on auth.users;
create trigger on_auth_user_created after insert on auth.users for each row execute procedure public.handle_new_user();
